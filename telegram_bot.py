import logging
import wikipedia
import requests
import asyncio
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes

# –¢–æ–∫–µ–Ω –±–æ—Ç–∞
BOT_TOKEN = "7606597523:AAEsP5mcWb7vSg971B3WT-p9pu92BzFBEDc"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)
wikipedia.set_lang("ru")
wikipedia.set_rate_limiting(False)  # –û—Ç–∫–ª—é—á–∞–µ–º –ª–∏–º–∏—Ç—ã

# –ö–æ–º–∞–Ω–¥–∞ /start
async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    welcome_text = """
üöó *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ò–ò-–±–æ—Ç Mercedes-Benz!*

–Ø –≤–∞—à –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è–º Mercedes-Benz!

*–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å –ø—Ä–æ Mercedes:*
‚Ä¢ "G-class" –∏–ª–∏ "–≥–µ–ª–∏–∫"
‚Ä¢ "S-class" –∏–ª–∏ "—ç—Å–∫–∞"
‚Ä¢ "E-class" –∏–ª–∏ "–µ—à–∫–∞" 
‚Ä¢ "C-class" –∏–ª–∏ "—Ü–µ—à–∫–∞"
‚Ä¢ "AMG" –∏–ª–∏ "–∞–º–µ–≥–∞"
‚Ä¢ "EQS" –∏–ª–∏ "—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏–π –º–µ—Ä—Å–µ–¥–µ—Å"
‚Ä¢ "GLC" –∏–ª–∏ "–≥—ç–ª—ç—Å"
‚Ä¢ "GLE" –∏–ª–∏ "–≥—ç–ª—ç–µ"

*–Ø –±—ã—Å—Ç—Ä–æ –Ω–∞–π–¥—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏ –ø–æ–∫–∞–∂—É –≤–∞–º!*
    """
    await update.message.reply_text(welcome_text, parse_mode='Markdown')

# –ë—ã—Å—Ç—Ä–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö Mercedes (–º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç)
def get_instant_mercedes_info(query):
    query_lower = query.lower().strip()
    
    # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏
    mercedes_db = {
        # G-Class
        'g-class': """üöô *Mercedes-Benz G-Class (–ì–µ–ª–∏–∫)*

*–¶–µ–Ω–∞:* –æ—Ç 12 900 000 ‚ÇΩ
*–ü–æ–∫–æ–ª–µ–Ω–∏—è:* W460, W461, W463
*–î–≤–∏–≥–∞—Ç–µ–ª–∏:* 2.0L - 4.0L V8 (–¥–æ 585 –ª.—Å.)
*–ü—Ä–∏–≤–æ–¥:* –ø–æ–ª–Ω—ã–π 4MATIC
*–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:* —Ä–∞–º–Ω–∞—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è, 3 –±–ª–æ–∫–∏—Ä—É–µ–º—ã—Ö –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª–∞

*–ò—Å—Ç–æ—Ä–∏—è:* –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –≤–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫ —Å 1979 –≥–æ–¥–∞, —Å–∏–º–≤–æ–ª —Ä–æ—Å–∫–æ—à–∏ –∏ –ø—Ä–æ—Ö–æ–¥–∏–º–æ—Å—Ç–∏.""",

        '–≥–µ–ª–∏–∫': """üöô *Mercedes-Benz G-Class (–ì–µ–ª–∏–∫)*

*–¶–µ–Ω–∞:* –æ—Ç 12 900 000 ‚ÇΩ
*–ú–æ—â–Ω–æ—Å—Ç—å:* –¥–æ 585 –ª.—Å. (G63 AMG)
*–†–∞–∑–≥–æ–Ω:* 4.5 —Å–µ–∫ –¥–æ 100 –∫–º/—á
*–†–∞—Å—Ö–æ–¥:* 13-16 –ª/100km

*–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏–∏:* G350d, G500, G63 AMG""",

        # S-Class
        's-class': """üöó *Mercedes-Benz S-Class (–≠—Å–∫–∞)*

*–¶–µ–Ω–∞:* –æ—Ç 8 900 000 ‚ÇΩ
*–ü–æ–∫–æ–ª–µ–Ω–∏—è:* W223, W222, W221
*–î–≤–∏–≥–∞—Ç–µ–ª–∏:* 2.9L - 4.0L V8 (–¥–æ 612 –ª.—Å.)
*–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:* DRIVE PILOT, MBUX Hyperscreen

*–§–ª–∞–≥–º–∞–Ω:* –≠—Ç–∞–ª–æ–Ω —Ä–æ—Å–∫–æ—à–∏ –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π —Å 1972 –≥–æ–¥–∞.""",

        '—ç—Å–∫–∞': """üöó *Mercedes-Benz S-Class (–≠—Å–∫–∞)*

*–¶–µ–Ω–∞:* –æ—Ç 8 900 000 ‚ÇΩ
*–î–ª–∏–Ω–∞:* 5179-5469 –º–º
*–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:* –º–∞—Å—Å–∞–∂–Ω—ã–µ –∫—Ä–µ—Å–ª–∞, –∞–≤—Ç–æ–ø–∏–ª–æ—Ç, —Å–∏—Å—Ç–µ–º–∞ –∫–æ–º—Ñ–æ—Ä—Ç–∞

*–ú–æ–¥–µ–ª–∏:* S350d, S450, S500, S580, S680""",

        # E-Class
        'e-class': """üöò *Mercedes-Benz E-Class (–ï—à–∫–∞)*

*–¶–µ–Ω–∞:* –æ—Ç 5 200 000 ‚ÇΩ
*–ü–æ–∫–æ–ª–µ–Ω–∏—è:* W214, W213, W212
*–î–≤–∏–≥–∞—Ç–µ–ª–∏:* 2.0L - 3.0L (–¥–æ 381 –ª.—Å.)
*–ö–ª–∞—Å—Å:* –±–∏–∑–Ω–µ—Å-—Å–µ–¥–∞–Ω

*–ü–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å:* –û–¥–Ω–∞ –∏–∑ —Å–∞–º—ã—Ö –ø—Ä–æ–¥–∞–≤–∞–µ–º—ã—Ö –º–æ–¥–µ–ª–µ–π Mercedes.""",

        '–µ—à–∫–∞': """üöò *Mercedes-Benz E-Class (–ï—à–∫–∞)*

*–¶–µ–Ω–∞:* –æ—Ç 5 200 000 ‚ÇΩ
*–ö—É–∑–æ–≤–∞:* —Å–µ–¥–∞–Ω, —É–Ω–∏–≤–µ—Ä—Å–∞–ª, –∫—É–ø–µ
*–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:* –¥–≤–æ–π–Ω–æ–π —ç–∫—Ä–∞–Ω, –ø–æ–ª—É–∞–≤—Ç–æ–Ω–æ–º–Ω–æ–µ –≤–æ–∂–¥–µ–Ω–∏–µ

*–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏–∏:* E200, E300, E450, E53 AMG""",

        # C-Class
        'c-class': """üöñ *Mercedes-Benz C-Class (–¶–µ—à–∫–∞)*

*–¶–µ–Ω–∞:* –æ—Ç 3 800 000 ‚ÇΩ
*–ü–æ–∫–æ–ª–µ–Ω–∏—è:* W206, W205
*–î–≤–∏–≥–∞—Ç–µ–ª–∏:* 1.5L - 3.0L (–¥–æ 390 –ª.—Å.)
*–ö–ª–∞—Å—Å:* –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å—Å–∫–∏–π

*–î–∏–∑–∞–π–Ω:* –°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π –∏ —ç–ª–µ–≥–∞–Ω—Ç–Ω—ã–π.""",

        '—Ü–µ—à–∫–∞': """üöñ *Mercedes-Benz C-Class (–¶–µ—à–∫–∞)*

*–¶–µ–Ω–∞:* –æ—Ç 3 800 000 ‚ÇΩ
*–†–∞–∑–≥–æ–Ω C43 AMG:* 4.6 —Å–µ–∫ –¥–æ 100 –∫–º/—á
*–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:* MBUX, —Ü–∏—Ñ—Ä–æ–≤–∞—è –ø—Ä–∏–±–æ—Ä–Ω–∞—è –ø–∞–Ω–µ–ª—å

*–ú–æ–¥–µ–ª–∏:* C180, C200, C300, C43 AMG""",

        # AMG
        'amg': """üèéÔ∏è *Mercedes-AMG (–ê–º–µ–≥–∞)*

*–¶–µ–Ω—ã:* –æ—Ç 6 500 000 ‚ÇΩ
*–û—Å–Ω–æ–≤–∞–Ω:* 1967 –≥–æ–¥
*–ú–æ–¥–µ–ª–∏:* C63, E63, G63, GT
*–ú–æ—â–Ω–æ—Å—Ç—å:* –¥–æ 831 –ª.—Å. (GT Black Series)

*–§–∏–ª–æ—Å–æ—Ñ–∏—è:* "–û–¥–∏–Ω —á–µ–ª–æ–≤–µ–∫ - –æ–¥–∏–Ω –¥–≤–∏–≥–∞—Ç–µ–ª—å".""",

        '–∞–º–µ–≥–∞': """üèéÔ∏è *Mercedes-AMG (–ê–º–µ–≥–∞)*

*–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–µ –≤–µ—Ä—Å–∏–∏:*
‚Ä¢ C63 AMG - 476 –ª.—Å.
‚Ä¢ E63 AMG - 612 –ª.—Å. 
‚Ä¢ G63 AMG - 585 –ª.—Å.
‚Ä¢ GT 63 S - 639 –ª.—Å.""",

        # EQS
        'eqs': """‚ö° *Mercedes-Benz EQS*

*–¶–µ–Ω–∞:* –æ—Ç 9 500 000 ‚ÇΩ
*–ó–∞–ø–∞—Å —Ö–æ–¥–∞:* –¥–æ 770 –∫–º
*–ú–æ—â–Ω–æ—Å—Ç—å:* –¥–æ 524 –ª.—Å.
*–†–∞–∑–≥–æ–Ω:* 4.3 —Å–µ–∫ –¥–æ 100 –∫–º/—á

*–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:* MBUX Hyperscreen, –∞–≤—Ç–æ–ø–∏–ª–æ—Ç, —Ä–µ–∫—É–ø–µ—Ä–∞—Ü–∏—è.""",

        # GLC
        'glc': """üöô *Mercedes-Benz GLC*

*–¶–µ–Ω–∞:* –æ—Ç 4 500 000 ‚ÇΩ
*–ö–ª–∞—Å—Å:* –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –∫—Ä–æ—Å—Å–æ–≤–µ—Ä
*–û–±—ä–µ–º –±–∞–≥–∞–∂–Ω–∏–∫–∞:* 550 –ª–∏—Ç—Ä–æ–≤
*–ü—Ä–∏–≤–æ–¥:* 4MATIC

*–ù–∞ –±–∞–∑–µ:* C-Class""",

        # GLE
        'gle': """üöô *Mercedes-Benz GLE*

*–¶–µ–Ω–∞:* –æ—Ç 6 800 000 ‚ÇΩ
*–ö–ª–∞—Å—Å:* —Å—Ä–µ–¥–Ω–µ—Ä–∞–∑–º–µ—Ä–Ω—ã–π –∫—Ä–æ—Å—Å–æ–≤–µ—Ä
*–î–≤–∏–≥–∞—Ç–µ–ª–∏:* –±–µ–Ω–∑–∏–Ω, –¥–∏–∑–µ–ª—å, –≥–∏–±—Ä–∏–¥
*–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:* –ø—Ä–æ—Å—Ç–æ—Ä–Ω—ã–π —Å–∞–ª–æ–Ω, E-ACTIVE BODY CONTROL""",

        # –û–±—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã
        '–º–µ—Ä—Å–µ–¥–µ—Å': """üöó *Mercedes-Benz*

*–û—Å–Ω–æ–≤–∞–Ω:* 1926 –≥–æ–¥
*–®—Ç–∞–±-–∫–≤–∞—Ä—Ç–∏—Ä–∞:* –®—Ç—É—Ç–≥–∞—Ä—Ç, –ì–µ—Ä–º–∞–Ω–∏—è
*–û—Å–Ω–æ–≤–∞—Ç–µ–ª–∏:* –ö–∞—Ä–ª –ë–µ–Ω—Ü, –ì–æ—Ç–ª–∏–± –î–∞–π–º–ª–µ—Ä

*–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–æ–¥–µ–ª—å–Ω—ã–π —Ä—è–¥:*
‚Ä¢ –°–µ–¥–∞–Ω—ã: A, C, E, S-Class
‚Ä¢ –í–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫–∏: GLA, GLB, GLC, GLE, GLS, G-Class
‚Ä¢ –≠–ª–µ–∫—Ç—Ä–æ–º–æ–±–∏–ª–∏: EQA, EQB, EQC, EQE, EQS
‚Ä¢ –°–ø–æ—Ä—Ç–∏–≤–Ω—ã–µ: AMG —Å–µ—Ä–∏–∏""",

        '–º–µ—Ä—Å': """üöó *Mercedes-Benz*

*–õ–æ–∑—É–Ω–≥:* "–õ—É—á—à–µ–µ –∏–ª–∏ –Ω–∏—á–µ–≥–æ"
*–ò–Ω–Ω–æ–≤–∞—Ü–∏–∏:* –ü–µ—Ä–≤—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å (1886), ABS, ESP, –ø–æ–¥—É—à–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

*–¢–µ–∫—É—â–∏–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:*
‚Ä¢ MBUX - –º—É–ª—å—Ç–∏–º–µ–¥–∏–π–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞
‚Ä¢ 4MATIC - –ø–æ–ª–Ω—ã–π –ø—Ä–∏–≤–æ–¥
‚Ä¢ DRIVE PILOT - –∞–≤—Ç–æ–ø–∏–ª–æ—Ç
‚Ä¢ ENERGIZING - —Å–∏—Å—Ç–µ–º–∞ –∫–æ–º—Ñ–æ—Ä—Ç–∞"""
    }
    
    # –ò—â–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
    if query_lower in mercedes_db:
        return mercedes_db[query_lower], None
    
    # –ò—â–µ–º —á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
    for key, value in mercedes_db.items():
        if key in query_lower:
            return value, None
    
    # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ –±–∞–∑–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫
    return fast_wikipedia_search(query)

# –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –≤ Wikipedia
def fast_wikipedia_search(query):
    try:
        # –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ —Ç–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∏ –∫—Ä–∞—Ç–∫–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è
        search_results = wikipedia.search(query, results=1)
        if not search_results:
            return "‚ùå –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å.", None
        
        page_title = search_results[0]
        # –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ 3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
        summary = wikipedia.summary(page_title, sentences=3)
        
        return f"üîç *{page_title}*\n\n{summary}", None
        
    except Exception as e:
        return f"üîç *{query}*\n\n–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É—Ç–æ—á–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å.", None

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
async def handle_all_messages(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_message = update.message.text.strip()
    
    if user_message.startswith('/'):
        return
    
    # –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
    typing_task = asyncio.create_task(
        update.message.reply_text("‚ö° *–ò—â—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é...*", parse_mode='Markdown')
    )
    
    # –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫
    info_text, image_url = get_instant_mercedes_info(user_message)
    
    # –û—Ç–º–µ–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–ò—â—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é..." –µ—Å–ª–∏ –æ–Ω–æ –µ—â–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
    try:
        typing_task.cancel()
    except:
        pass
    
    await update.message.reply_text(info_text, parse_mode='Markdown')

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
def main():
    try:
        application = Application.builder().token(BOT_TOKEN).build()
        application.add_handler(CommandHandler("start", start_command))
        application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_all_messages))
        
        print("ü§ñ –ò–ò-–±–æ—Ç Mercedes –∑–∞–ø—É—â–µ–Ω!")
        print("‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã")
        print("‚úÖ –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏")
        application.run_polling()
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")

if __name__ == '__main__':
    main()